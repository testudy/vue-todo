<!doctype html>
<html>
    <head>
        <title>Vue普通版本TODO</title>
        <link rel="stylesheet" href="/node_modules/bootstrap/dist/css/bootstrap.min.css" />
    </head>
    <body>
        <style>
            .container {
                width: 640px;
            }

            .table {
                table-layout: fixed;
            }

            .table th {
                text-align: center;
                vertical-align: middle;
            }

            .table td {
                vertical-align: middle;
            }

            .table .todo-number {
                width: 64px;
            }

            .table .todo-operation {
                width: 96px;
            }

            .table .form-check,
            .table .form-check-input {
                margin-right: 0;
            }
        </style>
        <div id="app" class="container">
            <common-form class="mt-3" @on-submit="create"></common-form>
            <table class="table table-striped table-hover mt-5">
                <thead class="thead-light">
                    <tr>
                        <th class="todo-number" scope="col">
                            <div class="form-check form-check-inline">
                                <input
                                    class="form-check-input"
                                    type="checkbox"
                                    value="#"
                                    :checked="toggleSelectAllState"
                                    @change.prevent="toggleSelectAll($event.target.checked)"
                                >
                            </div>
                        </th>
                        <th scope="col">代办列表</th>
                        <th class="todo-operation" scope="col">操作</th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <td colspan="3" class="text-right">
                            <button type="button" class="btn btn-link btn-sm" @click.prevent="selectAll">全选</button>
                            <button type="button" class="btn btn-link btn-sm" @click.prevent="toggle">反选</button>
                            <button type="button" class="btn btn-link text-danger btn-sm" @click.prevent="clean">清除</button>
                        </td>
                    </tr>
                </tfoot>
                <tbody>
                    <tr
                        is="todo-list-item"
                        v-for="item in todos"
                        :key="item.id"
                        :id="item.id"
                        :todo="item.todo"
                        :checked.sync="item.checked"
                        @on-update="update"
                        @on-remove="remove"
                    ></tr>
                </tbody>
            </table>
        </div>
        <script type="text/x-template" id="template-common-form">
            <form
                novalidate
                :class="{'was-validated': isFormValidated}"
                @submit.prevent="submit"
            >
                <div class="input-group">
                    <input
                        v-model="todoState"
                        type="text"
                        name="todo"
                        placeholder="Todo..."
                        required
                        class="form-control"
                        :class="{'form-control-lg': size === 'large', 'form-control-sm': size === 'small'}"
                        @keyup.esc="cancel"
                    />
                    <div class="invalid-tooltip">填入有效信息</div>
                    <div class="input-group-append">
                        <button
                            v-if="typeof $listeners['on-cancel'] === 'function'"
                            type="button"
                            class="btn btn-light"
                            :class="{'btn-lg': size === 'large', 'btn-sm': size === 'small'}"
                            @click.prevent="cancel"
                        >取消</button>
                        <button
                            type="submit"
                            class="btn btn-primary"
                            :class="{'btn-lg': size === 'large', 'btn-sm': size === 'small'}"
                            :disabled="isFormInvalid"
                        >{{btnSubmitText}}</button>
                    </div>
                </div>
            </form>
        </script>
        <script type="text/x-template" id="template-todo-list-item">
            <tr>
                <th scope="row">
                    <div class="form-check form-check-inline">
                        <input
                            class="form-check-input"
                            type="checkbox"
                            :value="id"
                            :checked="checked"
                            @change.prevent="$emit('update:checked', $event.target.checked)"
                        >
                    </div>
                </th>
                <td v-if="isEdit">
                    <common-form
                        :id="id"
                        :todo="todo"
                        size="small"
                        btn-submit-text="修改"
                        @on-cancel="deactivateEdit"
                        @on-submit="update"
                    ></common-form>
                </td>
                <td v-else @click="activateEdit">
                    {{todo}}
                </td>
                <td class="text-center">
                    <button
                        type="button"
                        class="btn btn-link text-danger btn-sm"
                        @click.prevent="remove(id)"
                    >删除</button>
                </td>
            </tr>
        </script>
        <script src="/node_modules/vue/dist/vue.min.js"></script>
        <script>
            (function () {
                'use strict';

                var CommonForm = {
                    props: {
                        id: {
                            type: String,
                            default: '',
                        },
                        todo: {
                            type: String,
                            default: '',
                        },
                        size: {
                            type: String,
                            default: 'normal',
                            validator: function () {
                                return ['large', 'normal', 'small'].indexOf !== -1;
                            },
                        },
                        btnSubmitText: {
                            type: String,
                            default: '确定',
                        },
                    },
                    data: function () {
                        return {
                            todoState: this.todo,
                            isFormValidated: false,
                        };
                    },
                    computed: {
                        isFormInvalid: function () {
                            return !this.todoState;
                        },
                    },
                    created: function () {
                        var unwatch = this.$watch('todoState', function () {
                            this.isFormValidated = true;
                            unwatch();
                        });
                    },
                    template: '#template-common-form',
                    methods: {
                        reset: function () {
                            this.todoState = '';
                            this.isFormValidated = false;
                            var unwatch = this.$watch('todoState', function () {
                                this.isFormValidated = true;
                                unwatch();
                            });
                        },
                        cancel: function () {
                            if (typeof this.$listeners['on-cancel'] === 'function') {
                                this.$listeners['on-cancel']();
                            }
                        },
                        submit: function () {
                            if (typeof this.$listeners['on-submit'] === 'function') {
                                this.$listeners['on-submit']({
                                    id: this.id,
                                    todo: this.todoState,
                                });
                            }
                            this.reset();
                        },
                    },
                };

                var TodoListItem = {
                    components: {
                        CommonForm: CommonForm,
                    },
                    props: {
                        id: {
                            type: String,
                            required: true,
                        },
                        todo: {
                            type: String,
                            required: true,
                        },
                        checked: {
                            type: Boolean,
                            default: false,
                        },
                    },
                    data: function () {
                        return {
                            isEdit: false,
                        };
                    },
                    methods: {
                        activateEdit: function () {
                            this.isEdit = true;
                        },
                        deactivateEdit: function () {
                            this.isEdit = false;
                        },
                        update: function (modal) {
                            if (typeof this.$listeners['on-update'] === 'function') {
                                this.$listeners['on-update'](modal);
                            }
                            this.deactivateEdit();
                        },
                        remove: function (id) {
                            if (typeof this.$listeners['on-remove'] === 'function') {
                                this.$listeners['on-remove'](id);
                            }
                        },
                    },
                    template: '#template-todo-list-item',
                };

                var app = new Vue({
                    el: '#app',
                    components: {
                        CommonForm: CommonForm,
                        TodoListItem: TodoListItem,
                    },
                    data: {
                        todos: [],
                        toggleSelectAllState: false,
                    },
                    watch: {
                        todos: function (value) {
                            var selectAllState = true;
                            this.todos.forEach((item) => {
                                if (!item.checked) {
                                    selectAllState = false;
                                }
                            });
                            this.toggleSelectAllState = selectAllState;
                        },

                        /*
                        存在循环watch，如何解决呢？问强哥
                        toggleSelectAllState: function (checked) {
                            console.log(arguments);
                            this.todos = this.todos.map((item) => {
                                return Object.assign({}, item, {checked: checked});
                            });
                        },
                        */
                    },
                    methods: {
                        /*
                         * 利用random随机数生成伪GUID
                         * https://zh.wikipedia.org/wiki/全局唯一标识符
                         * https://baike.baidu.com/view/185358.htm
                         */
                        guid: function () {
                            const raw = [
                                Math.random().toString(31).substr(2),
                                Math.random().toString(31).substr(2),
                                Math.random().toString(31).substr(2),
                            ].join('').substr(0, 32);
                            return raw.replace(/(\S{8})(\S{4})(\S{4})(\S{4})(\S{12})/, '$1-$2-$3-$4-$5');
                        },

                        create: function (modal) {
                            console.log(modal);
                            modal.id = this.guid();
                            this.todos.push(modal);
                        },

                        update: function (modal) {
                            var index = this.todos.findIndex(item => item.id === modal.id);
                            this.todos.splice(index, 1, modal);
                        },

                        remove: function (id) {
                            var index = this.todos.findIndex(item => item.id === id);
                            this.todos.splice(index, 1);
                        },

                        toggleSelectAll: function (checked) {
                            this.todos = this.todos.map((item) => {
                                return Object.assign({}, item, {checked: checked});
                            });
                        },

                        selectAll: function () {
                            this.todos = this.todos.map((item) => {
                                return Object.assign({}, item, {checked: true});
                            });
                        },

                        toggle: function () {
                            this.todos = this.todos.map((item) => {
                                return Object.assign({}, item, {checked: !item.checked});
                            });
                        },

                        clean: function () {
                            this.todos = this.todos.filter(item => !item.checked);
                        },

                    },
                });
            }());
        </script>
    </body>
</html>
